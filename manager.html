
<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Manager Dashboard – LitLatte POS</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<link rel="stylesheet" href="assets/css/manager-styles.css">

<script src="https://unpkg.com/lucide@latest"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>

<!-- FIREBASE -->
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js";
import { getFirestore, collection, getDocs } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";




const firebaseConfig = {
  apiKey: "AIzaSyAd7ZD-YonKHor0twOWSyPAE6ix9LXLeGI",
  authDomain: "pos2-27d04.firebaseapp.com",
  projectId: "pos2-27d04",
  storageBucket: "pos2-27d04.firebasestorage.app",
  messagingSenderId: "394720721108",
  appId: "1:394720721108:web:b0d8decc48bc01abfba341"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

await signInAnonymously(auth);

window.Firebase = { db };
window.FirestoreHelpers = { collection, getDocs };
window.firebaseReady = true;
</script>
</head>

<body>


<header class="top-header">
  <h3 style="color:#fff">LitLatte POS – Manager</h3>
</header>

<div class="container">

<aside class="sidebar">
  <button class="nav-btn active" id="dashboardBtn"><i data-lucide="layout-dashboard"></i> Dashboard</button>
  <button class="nav-btn" id="salesHistoryBtn"><i data-lucide="receipt"></i> Sales History</button>
  <button class="nav-btn" id="manageCrewBtn"><i data-lucide="users"></i> Manage Crew</button>
  <button class="nav-btn" id="returnBtn"><i data-lucide="corner-up-left"></i> Return to POS</button>
  <button class="nav-btn" id="logoutBtn"><i data-lucide="log-out"></i> Logout</button>
</aside>

<main class="content" id="mainContent">

<section id="dashboardView">
<h2>Overview</h2><br>

<div class="dashboard-grid">
  <div class="stat-card"><h4>Total Revenue</h4><div id="totalRevenue">₱0.00</div></div>
  <div class="stat-card"><h4>Total Orders</h4><div id="totalOrders">0</div></div>
  <div class="stat-card"><h4>Total Customers</h4><div id="totalCustomers">—</div></div>
  <div class="stat-card"><h4>Net Profit</h4><div id="netProfit">₱0.00</div></div>
  <div class="stat-card"><h4>Average Sale</h4><div id="avgSale">₱0.00</div></div>
</div>

<div class="dashboard-grid" style="grid-template-columns:2fr 1fr;">
  <div class="stat-card" style="background:#fff; border-radius:12px; padding:20px; box-shadow:0 4px 12px rgba(0,0,0,0.05); margin-bottom:20px;">
    <h4 style="margin-bottom:12px; font-size:18px; color:#333;">Sales Over Time</h4>
    
    <button onclick="drawRevenue('hour')" style="background-color:#a80000; color:#fff; border:none; padding:8px 16px; margin-right:8px; margin-bottom:12px; border-radius:8px; cursor:pointer; font-size:14px; transition:all 0.2s;">Hour</button>
    
    <button onclick="drawRevenue('day')" style="background-color:#a80000; color:#fff; border:none; padding:8px 16px; margin-right:8px; margin-bottom:12px; border-radius:8px; cursor:pointer; font-size:14px; transition:all 0.2s;">Day</button>
    
    <button onclick="drawRevenue('week')" style="background-color:#a80000; color:#fff; border:none; padding:8px 16px; margin-right:8px; margin-bottom:12px; border-radius:8px; cursor:pointer; font-size:14px; transition:all 0.2s;">Week</button>
    
    <div style="height:300px;">
      <canvas id="revenueChart"></canvas>
    </div>
  </div>
  

  <div class="stat-card">
    <h4>Sales by Category</h4>
    <canvas id="categoryChart"></canvas>
  </div>
</div>

<div class="stat-card">
  <h4>Top 10 Products</h4>
  <ol id="topProductsList" class="top-products-list"></ol>
</div>


</section>
</main>
</div>

<script>
/* ================= AUTH ================= */
if (localStorage.getItem("loggedIn") !== "true") {
  location.href = "login.html";
}

/* ================= GLOBAL ================= */
let ordersCache = [];
let revenueChart = null;
let categoryChart = null;
let salesData = {};
let categoryData = {};
let productData = {};

const el = id => document.getElementById(id);
const mainContent = el("mainContent");
const dashboardHTML = el("dashboardView").outerHTML;

/* ================= FIREBASE ================= */
async function waitForFirebase() {
  while (!window.firebaseReady) {
    await new Promise(r => setTimeout(r, 50));
  }
}

async function fetchOrders() {
  if (ordersCache.length) return ordersCache;
  const snap = await FirestoreHelpers.getDocs(
    FirestoreHelpers.collection(Firebase.db, "orders")
  );
  ordersCache = snap.docs.map(d => d.data());
  return ordersCache;
}

/* ================= DASHBOARD ================= */
async function loadDashboard() {
  mainContent.innerHTML = dashboardHTML;
  await waitForFirebase();
  const orders = await fetchOrders();

  let revenue = 0;
  let customers = new Set();

  const hourly = Array(24).fill(0);
  const daily = {};
  const weekly = { "Week 1":0, "Week 2":0, "Week 3":0, "Week 4":0, "Week 5":0 };
  const categories = {};
  const products = {};

  orders.forEach(o => {
    const total = o.totals?.total || 0;
    revenue += total;

    if (o.customerName) customers.add(o.customerName);
    if (!o.createdAt?.seconds) return;
  const d = new Date(o.createdAt.seconds * 1000);
  if (isNaN(d)) return;


    hourly[d.getHours()] += total;
    
    const dayKey = d.toISOString().split("T")[0]; // YYYY-MM-DD
    daily[dayKey] = (daily[dayKey] || 0) + total;

    weekly[`Week ${Math.ceil(d.getDate()/7)}`] += total;

    (o.items || []).forEach(i => {
      categories[i.category] = (categories[i.category] || 0) + i.qty;
      products[i.name] = (products[i.name] || 0) + i.qty;
    });
  });

  salesData = { hour: hourly, day: daily, week: weekly };
  categoryData = categories;
  productData = products;

  el("totalRevenue").textContent = `₱${revenue.toFixed(2)}`;
  el("totalOrders").textContent = orders.length;
  el("totalCustomers").textContent = customers.size || "—";
  el("netProfit").textContent = `₱${(revenue * 0.65).toFixed(2)}`;
  el("avgSale").textContent = `₱${(revenue / orders.length || 0).toFixed(2)}`;

  drawRevenue("day");
  drawCategory();
  drawTopProducts();
}

/* ================= CHARTS ================= */
function drawRevenue(type) {
  if (revenueChart) revenueChart.destroy();

  let labels = [];
  let values = [];

  if (type === "hour") {
    labels = [...Array(24).keys()].map(h => `${h}:00`);
    values = salesData.hour;
  }

  if (type === "day") {
    labels = Object.keys(salesData.day).sort(
      (a, b) => new Date(a) - new Date(b)
    );
    values = labels.map(l => salesData.day[l] || 0);
  }

  if (type === "week") {
    labels = Object.keys(salesData.week);
    values = Object.values(salesData.week);
  }

  revenueChart = new Chart(el("revenueChart"), {
    type: "bar",
    data: {
      labels,
      datasets: [{
        label: "Total Revenue (₱)",
        data: values,
        backgroundColor: "#7a1212",
        borderRadius: 8
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      animation: {
        duration: 1200,
        easing: "easeOutQuart"
      },
      scales: {
        y: {
          beginAtZero: true,
          ticks: {
            callback: value => `₱${value}`
          }
        }
      },
      plugins: {
        legend: {
          display: true
        }
      }
    }
  });
}


function drawCategory() {
  if (categoryChart) categoryChart.destroy();

  const ctx = el("categoryChart").getContext("2d");

  const gradients = [
    (() => {
      const g = ctx.createLinearGradient(0, 0, 200, 200);
      g.addColorStop(0, "#7a1212"); // maroon
      g.addColorStop(1, "#b22222"); // firebrick
      return g;
    })(),
    (() => {
      const g = ctx.createLinearGradient(0, 0, 200, 200);
      g.addColorStop(0, "#b22222"); // red
      g.addColorStop(1, "#ff0012"); // light red
      return g;
    })(),
    (() => {
      const g = ctx.createLinearGradient(0, 0, 200, 200);
      g.addColorStop(0, "#1f1f1f"); // light black
      g.addColorStop(1, "#434343");
      return g;
    })(),
    (() => {
      const g = ctx.createLinearGradient(0, 0, 200, 200);
      g.addColorStop(0, "#8b0000"); // dark red
      g.addColorStop(1, "#ff9999");
      return g;
    })()
  ];

  categoryChart = new Chart(ctx, {
    type: "doughnut",
    data: {
      labels: Object.keys(categoryData),
      datasets: [{
        data: Object.values(categoryData),
        backgroundColor: gradients,
        borderWidth: 0,
        hoverOffset: 12
      }]
    },
    options: {
      cutout: "65%",
      plugins: {
        legend: {
          position: "bottom",
          labels: {
            padding: 20,
            font: { size: 12 }
          }
        }
      }
    }
  });
}

function drawTopProducts() {
  const list = document.getElementById("topProductsList");
  list.innerHTML = "";

  Object.entries(productData)
    .sort((a, b) => b[1] - a[1])
    .slice(0, 10)
    .forEach(([name, qty], index) => {
      const li = document.createElement("li");

      if (index < 3) li.classList.add("top-three");

      li.innerHTML = `
        <span class="product-rank">${index + 1}.</span><br>
        <span class="product-name">${name}</span><br>
        <span class="product-qty">${qty} sold</span>
      `;

      list.appendChild(li);
    });
}



/* ================= SALES HISTORY ================= */
let deleteTargetId = null;

async function loadSalesHistory() {
  await waitForFirebase();
  const snap = await FirestoreHelpers.getDocs(
    FirestoreHelpers.collection(Firebase.db, "orders")
  );

  let html = `
    <h2>Sales History</h2>
    <table>
      <thead>
        <tr>
          <th>#</th>
          <th>Date</th>
          <th>Customer</th>
          <th>Total</th>
          <th>View</th>
          <th>Delete</th>
        </tr>
      </thead>
      <tbody>
  `;

  snap.docs.forEach((doc, i) => {
    const o = doc.data();
    html += `
      <tr>
        <td>${i + 1}</td>
        <td>${o.createdAt ? new Date(o.createdAt.seconds * 1000).toLocaleString() : "—"}</td>
        <td>${o.customerName || "Walk-in"}</td>
        <td>₱${o.totals?.total.toFixed(2)}</td>
        <td>
          <i data-lucide="eye" style="cursor:pointer"
             onclick='viewReceipt(${JSON.stringify(o)})'></i>
        </td>
        <td>
          <i data-lucide="trash-2" style="cursor:pointer;color:#a80000"
             onclick="askDelete('${doc.id}')"></i>
        </td>
      </tr>
    `;
  });

  mainContent.innerHTML = html + "</tbody></table>";
  lucide.createIcons();
}


/* ================= CREW ================= */
async function loadCrew() {
  await waitForFirebase();
  const snap = await FirestoreHelpers.getDocs(
    FirestoreHelpers.collection(Firebase.db,"employees")
  );

  let html=`<h2>Manage Crew</h2><table><thead>
  <tr><th>ID</th><th>First</th><th>Last</th></tr>
  </thead><tbody>`;

  snap.docs.forEach(d=>{
    const c=d.data();
    html+=`<tr>
      <td>${c.crewId}</td>
      <td>${c.firstName}</td>
      <td>${c.lastName}</td>
    </tr>`;
  });

  mainContent.innerHTML=html+"</tbody></table>";
}

/* ================= NAV ================= */
dashboardBtn.onclick = loadDashboard;
salesHistoryBtn.onclick = loadSalesHistory;
manageCrewBtn.onclick = loadCrew;
returnBtn.onclick = () => location.href="main.html";
logoutBtn.onclick = () => { localStorage.removeItem("loggedIn"); location.href="login.html"; };


function viewReceipt(order) {
  const body = document.getElementById("receiptBody");

  body.innerHTML = `
    <p><strong>Date:</strong> ${new Date(order.createdAt.seconds * 1000).toLocaleString()}</p>
    <p><strong>Customer:</strong> ${order.customerName || "Walk-in"}</p>
    <hr>
    ${(order.items || []).map(i => `
      <div>
        ${i.qty} × ${i.name} — ₱${(i.qty * i.price).toFixed(2)}
      </div>
    `).join("")}
    <hr>
    <strong>Total: ₱${order.totals.total.toFixed(2)}</strong>
  `;

  document.getElementById("receiptModal").classList.remove("hidden");
}

function closeReceipt() {
  document.getElementById("receiptModal").classList.add("hidden");
}
window.askDelete = function (id) {
  deleteTargetId = id;

  const modal = document.getElementById("deleteModal");
  modal.classList.remove("hidden");

  /* Overlay fix */
  modal.style.display = "flex";
  modal.style.alignItems = "center";
  modal.style.justifyContent = "center";
  modal.style.position = "fixed";
  modal.style.inset = "0";
  modal.style.background = "rgba(0,0,0,0.55)";
  modal.style.zIndex = "9999";

  /* BUTTON STYLING (INLINE ONLY) */
  const buttons = modal.querySelectorAll("button");

  buttons.forEach(btn => {
    btn.style.padding = "12px 24px";
    btn.style.borderRadius = "10px";
    btn.style.fontSize = "14px";
    btn.style.fontWeight = "600";
    btn.style.border = "none";
    btn.style.cursor = "pointer";
    btn.style.minWidth = "120px";
    btn.style.pointerEvents = "auto";
    btn.style.transition = "all 0.2s ease";
  });

  /* DELETE button */
  const deleteBtn = modal.querySelector(".danger") || buttons[0];
  deleteBtn.style.background = "#a80000";
  deleteBtn.style.color = "#fff";
  deleteBtn.onclick = window.confirmDelete;
  deleteBtn.onmouseenter = () => deleteBtn.style.background = "#7a1212";
  deleteBtn.onmouseleave = () => deleteBtn.style.background = "#a80000";

  /* CANCEL button */
  const cancelBtn = buttons[1];
  cancelBtn.style.background = "#e5e5e5";
  cancelBtn.style.color = "#333";
  cancelBtn.onclick = window.closeDelete;
  cancelBtn.onmouseenter = () => cancelBtn.style.background = "#d4d4d4";
  cancelBtn.onmouseleave = () => cancelBtn.style.background = "#e5e5e5";
};

window.closeDelete = function () {
  deleteTargetId = null;

  const modal = document.getElementById("deleteModal");
  modal.classList.add("hidden");
  modal.style.display = "none";
};

window.confirmDelete = async function () {
  if (!deleteTargetId) {
    console.error("No deleteTargetId set");
    return;
  }

  try {
    await FirestoreHelpers.deleteDoc(
      FirestoreHelpers.doc(Firebase.db, "orders", deleteTargetId)
    );

    console.log("Order deleted:", deleteTargetId);

    deleteTargetId = null;
    ordersCache = [];

    const modal = document.getElementById("deleteModal");
    modal.classList.add("hidden");
    modal.style.display = "none";

    loadSalesHistory(); // refresh table
  } catch (err) {
    console.error("Delete failed:", err);
    alert("Failed to delete order. Check console.");
  }

  loadSalesHistory();
};



lucide.createIcons();
loadDashboard();
</script>

<!-- VIEW RECEIPT MODAL -->
<div id="receiptModal" class="modal hidden">
  <div class="modal-content">
    <h3>Receipt</h3>
    <div id="receiptBody"></div>
    <button onclick="closeReceipt()">Close</button>
  </div>
</div>

<!-- DELETE CONFIRM MODAL -->
<div id="deleteModal" class="modal hidden">
  <div class="modal-content">
    <h3>Delete Transaction</h3>
    <br><p>Are you sure you want to delete this transaction?</p><br><br><br>
    <div class="modal-actions">
      <button onclick="confirmDelete()" class="danger">Delete</button>
      <button onclick="closeDelete()">Cancel</button>
    </div>
  </div>
</div>


</body>
</html>
