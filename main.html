<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Food Order - LitLatte POS</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="assets/css/styles.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

  <!-- ICONS -->
<script src="https://unpkg.com/lucide@latest"></script>


  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
    import { getAnalytics } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-analytics.js";
    import { getAuth } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js";
    import { getFirestore } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";
    import { deleteDoc, doc } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";


    const firebaseConfig = {
      apiKey: "AIzaSyAd7ZD-YonKHor0twOWSyPAE6ix9LXLeGI",
      authDomain: "pos2-27d04.firebaseapp.com",
      projectId: "pos2-27d04",
      storageBucket: "pos2-27d04.firebasestorage.app",
      messagingSenderId: "394720721108",
      appId: "1:394720721108:web:b0d8decc48bc01abfba341",
      measurementId: "G-KLWC55M3BW"
    };

    const app = initializeApp(firebaseConfig);
    const analytics = getAnalytics(app);
    const auth = getAuth(app);
    const db = getFirestore(app);

    window.Firebase = { app, analytics, auth, db };

 
    if (localStorage.getItem('loggedIn') !== 'true') {
      window.location.href = "login.html";
    }
  </script>
</head>

<script>
  document.addEventListener("DOMContentLoaded", () => {
    const managerBtn = document.getElementById("managerBtn");
    const MANAGER_PIN = "1234";

    if (!managerBtn) return;

    managerBtn.addEventListener("click", () => {
      const enteredPin = prompt("Enter Manager PIN:");

      // Handle cancel or empty input
      if (enteredPin === null || enteredPin.trim() === "") {
        return;
      }

      // Validate PIN
      if (enteredPin !== MANAGER_PIN) {
        alert("Incorrect Manager PIN.");
        return;
      }

      // Authorized access
      window.location.href = "manager.html";
    });
  });
</script>


<body>

  <header class="top-header">
    <div class="header-left">
      <h1>LitLatte POS</h1>
    </div>
    <div class="header-right">
      <button id="managerBtn" class="manager-btn"><i class="fas fa-user-shield"></i> Manager</button>
    </div>
  </header>

  <div class="main-container">
    
    <aside class="sidebar">
      <div class="sidebar-title">MENU</div>
    
      <nav class="sidebar-nav">
        <button class="nav-btn active" data-view="dashboard">
          <i data-lucide="layout-dashboard"></i>
          <span>Dashboard</span>
        </button>

        <button class="nav-btn" data-view="products">
          <i data-lucide="coffee"></i>
          <span>Products</span>
        </button>

    
      <div class="sidebar-divider"></div>
    
      <nav class="sidebar-nav">
        <button class="nav-btn danger" id="logoutBtn">
          <i data-lucide="log-out"></i>
          <span>Logout</span>
        </button>
      </nav>
    </aside>
    

  
    <main class="main-content">
     
      <div class="search-filter-bar">
        <div class="search-box">
          <i class="fas fa-search"></i>
          <input type="text" placeholder="Search food" id="searchInput">
        </div>
      </div>

    
      <div class="categories-section">
        <div class="categories-scroll">
          <button class="category-btn active" data-category="all">
            <span class="category-emoji">üçΩÔ∏è</span>
            <span>All Menu</span>
          </button>
          <button class="category-btn" data-category="All Day Breakfast">
            <span class="category-emoji">üç≥</span>
            <span>All Day Breakfast</span>
          </button>
          <button class="category-btn" data-category="Nibblers">
            <span class="category-emoji">üçó</span>
            <span>Nibblers</span>
          </button>
          <button class="category-btn" data-category="Specialties">
            <span class="category-emoji">‚≠ê</span>
            <span>Specialties</span>
          </button>
          <button class="category-btn" data-category="Pasta Pride">
            <span class="category-emoji">üçù</span>
            <span>Pasta Pride</span>
          </button>
          <button class="category-btn" data-category="Salads">
            <span class="category-emoji">ü•ó</span>
            <span>Salads</span>
          </button>
          <button class="category-btn" data-category="Drinks">
            <span class="category-emoji">‚òï</span>
            <span>Drinks</span>
          </button>
          <button class="category-btn" data-category="Desserts">
            <span class="category-emoji">üç∞</span>
            <span>Desserts</span>
          </button>
          <button class="category-btn" data-category="Soups">
            <span class="category-emoji">üç≤</span>
            <span>Soups</span>
          </button>
        </div>
      </div>

      
      <div class="product-tabs">
        <button class="tab-btn active" data-tab="popular">Popular</button>
      </div>

    
      <div class="products-grid" id="productsGrid"></div>
    </main>

    
    <aside class="invoice-sidebar">
      <div class="invoice-card">
        <div class="bill-header">
          <h2 class="invoice-title">Bill Details</h2>
          <span class="bill-number" id="billNumber"></span>
        </div>
        
        <div class="customer-section">
          <label class="section-label">Customer Name</label>
          <input type="text" id="customerName" class="customer-input" placeholder="Enter customer name">
        </div>
        
        <div class="order-items-section">
          <h3 class="section-title">Order Details</h3>
          <div class="invoice-items" id="invoiceItems">
            <div class="empty-cart-message">
              <i class="fas fa-shopping-cart"></i>
              <p>No items in cart</p>
            </div>
          </div>
        </div>

        <div class="payment-summary">
          <div class="summary-row">
            <span>Items</span>
            <span id="invoiceItemCount">0</span>
          </div>
          <div class="summary-row">
            <span>Subtotal</span>
            <span id="invoiceSubtotal">‚Ç±0.00</span>
          </div>
          <div class="summary-row" id="invoiceDiscountRow" style="display: none;">
            <span>Discount</span>
            <span id="invoiceDiscount" style="color: var(--maroon-primary);">-‚Ç±0.00</span>
          </div>
          <div class="summary-row">
            <span>Tax (12%)</span>
            <span id="invoiceTax">‚Ç±0.00</span>
          </div>
          <div class="summary-row total-row">
            <span>Total</span>
            <span id="invoiceTotal" style="color: var(--maroon-primary); font-weight: 700;">‚Ç±0.00</span>
          </div>
        </div>

        <div class="table-section">
          <label class="section-label">Select Table</label>
          <input type="number" id="tableSelect" class="table-input" placeholder="Enter table number" min="1" max="999">
        </div>

        <div class="payment-methods">
          <h3 class="section-title">Select Payment</h3>
          <div class="payment-buttons-sidebar">
            <button class="payment-method-btn-sidebar" data-method="cash">
              <div class="payment-icon-sidebar cash-icon-sidebar">
                <img src="assets/img/cash-logo.png" alt="Cash" class="payment-logo" onerror="this.onerror=null; this.style.display='none'; this.parentElement.innerHTML='<i class=\'fas fa-money-bill-wave\'></i>';">
              </div>
              <span>Pay with Cash</span>
            </button>
            <button class="payment-method-btn-sidebar" data-method="gcash">
              <div class="payment-icon-sidebar gcash-icon-sidebar">
                <img src="assets/img/gcash-logo.png" alt="GCash" class="payment-logo" onerror="this.onerror=null; this.style.display='none'; this.parentElement.innerHTML='<span style=\'font-weight: bold;\'>GC</span>';">
              </div>
              <span>Pay with GCash</span>
            </button>
            <button class="payment-method-btn-sidebar" data-method="card">
              <div class="payment-icon-sidebar card-icon-sidebar">
                <img src="assets/img/card-logo.png" alt="Card" class="payment-logo" onerror="this.onerror=null; this.style.display='none'; this.parentElement.innerHTML='<i class=\'fas fa-credit-card\'></i>';">
              </div>
              <span>Pay with Card</span>
            </button>
          </div>
        </div>

        <button class="place-order-btn" id="doneBtn">
          Process Transaction
        </button>
      </div>
    </aside>
  </div>

  
  <div id="productModal" class="product-modal">
    <div class="product-modal-content">
      <button class="modal-close-btn" id="closeProductModal">
        <i class="fas fa-times"></i>
      </button>
      
      
      <div class="product-modal-header">
        <div class="product-modal-image">
          <img id="modalProductImage" src="" alt="">
        </div>
        <div class="product-modal-info">
          <h2 id="modalProductName"></h2>
          <p class="product-modal-category" id="modalProductCategory"></p>
          <p class="product-modal-price" id="modalProductBasePrice"></p>
        </div>
      </div>

      
      <div class="product-modal-section">
        <label class="section-label">Quantity</label>
        <div class="quantity-control">
          <button class="qty-btn" id="decreaseQty">-</button>
          <input type="number" id="productQuantity" value="1" min="1" max="99">
          <button class="qty-btn" id="increaseQty">+</button>
        </div>
        <p class="stock-indicator">In stock: <span id="stockCount">50</span></p>
      </div>

      
      <div class="product-modal-section" id="sizeSection" style="display: none;">
        <label class="section-label">Size <span class="required-badge">Required</span></label>
        <div class="options-group" id="requiredOptions">
          
        </div>
      </div>

     
      <div class="product-modal-section">
        <label class="section-label">Add-ons (Optional)</label>
        <div class="options-group" id="optionalAddons">
         
        </div>
      </div>

      
      <div class="product-modal-section">
        <label class="section-label">Modifiers</label>
        <div class="modifier-buttons" id="modifierButtons">
          
        </div>
      </div>

      
      <div class="product-modal-section">
        <label class="section-label">Special Instructions</label>
        <textarea id="specialInstructions" placeholder="Special instructions (kitchen will see this)" maxlength="100"></textarea>
        <p class="char-count"><span id="charCount">0</span>/100</p>
      </div>

      
      <div class="product-modal-section price-breakdown">
        <div class="breakdown-row">
          <span>Base price</span>
          <span id="breakdownBase">‚Ç±0.00</span>
        </div>
        <div class="breakdown-row">
          <span>Quantity</span>
          <span id="breakdownQty">√ó 1</span>
        </div>
        <div class="breakdown-row total-breakdown">
          <span>Total</span>
          <span id="breakdownTotal">‚Ç±0.00</span>
        </div>
      </div>

      
      <div class="product-modal-actions">
        <button class="btn-secondary" id="cancelProductModal">Cancel</button>
        <button class="btn-primary" id="addToOrderBtn" disabled>Add to Order - <span id="addToOrderPrice">‚Ç±0.00</span></button>
      </div>
    </div>
  </div>

  <!-- GCash QR Code Modal -->
  <div id="gcashModal" class="modal">
    <div class="payment-process-modal">
      <button class="modal-close-btn" id="closeGCashModal">
        <i class="fas fa-times"></i>
      </button>
      <h2>GCash Payment</h2>
      
      <div class="qr-code-container">
        <img 
          src="assets/img/gcash-qr.png"
          alt="GCash QR Code"
          class="gcash-qr-image"
          style="width: 350px; height: auto; display: block; margin: 0 auto;"
        >
      </div>
      
      

      <div class="timer-display">
        <p>Time remaining: <span id="gcashTimer">10</span> seconds</p>
      </div>
      <div class="payment-verification">
        <p>Please wait for customer to scan the QR code...</p>
        <div class="verification-buttons">
          <button class="btn-secondary" id="gcashCancel">Cancel</button>
          <button class="btn-success" id="gcashSuccess">Payment Successful</button>
          <button class="btn-danger" id="gcashFailed">Payment Failed</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Card Payment Modal -->
  <div id="cardModal" class="modal">
    <div class="payment-process-modal">
      <div class="payment-modal-header">
        <h2>Card Payment</h2>
        <button class="modal-close-btn" id="closeCardModal">
          <i class="fas fa-times"></i>
        </button>
      </div>
      <div class="card-payment-form">
        <div class="form-group">
          <label for="accountNumber">Account Number</label>
          <input type="text" id="accountNumber" placeholder="Enter account number" class="form-input" maxlength="20">
        </div>
        <div class="form-group">
          <label for="cardPin">PIN</label>
          <input type="password" id="cardPin" placeholder="Enter PIN" class="form-input" maxlength="6">
        </div>
        <div class="form-group">
          <label for="totalAmount">Total Amount</label>
          <input type="text" id="totalAmount" class="form-input" readonly>
        </div>
        <div class="form-actions">
          <button type="button" id="cardCancel" class="btn-secondary">Cancel</button>
          <button type="button" id="cardConfirm" class="btn-primary">Confirm Payment</button>
        </div>
      </div>
    </div>
  </div>


  <!-- Payment Modal -->
  <div id="paymentModal" class="modal">
    <div class="payment-modal-box">
      <div class="payment-modal-header">
        <h2>Complete Payment</h2>
        <button class="modal-close-btn" id="closePaymentModal">
          <i class="fas fa-times"></i>
        </button>
      </div>
      
      <div class="payment-modal-body">
        <div class="order-summary-section">
          <h3>Order Summary</h3>
          <div class="payment-cart-items" id="modalCartItems"></div>
          
          <div class="payment-total-section">
            <div class="payment-summary-row">
              <span>Subtotal</span>
              <span id="modalSubtotal">‚Ç±0.00</span>
            </div>
            <div class="payment-summary-row" id="discountRow" style="display: none;">
              <span id="discountLabel">Discount</span>
              <span id="modalDiscount">-‚Ç±0.00</span>
            </div>
            <div class="payment-summary-row">
              <span>VAT (12%)</span>
              <span id="modalVat">‚Ç±0.00</span>
            </div>
            <div class="payment-summary-row payment-total">
              <span style="color:#ffffff;">Total</span>
              <span id="modalTotal" style="color:#ffffff; font-weight:700; font-size:20px;">
                ‚Ç±0.00
              </span>
            </div>
            
          </div>
        </div>

        <form id="paymentForm">
          <div class="payment-method-section">
            <h3>Payment Method</h3>
            <div class="payment-method-grid">
              <label class="payment-method-card">
                <input type="radio" name="payment" value="cash" required>
                <div class="payment-card-content">
                  <div class="payment-icon-wrapper cash-icon">
                    <i class="fas fa-money-bill-wave"></i>
                  </div>
                  <div class="payment-text">
                    <span class="payment-name">Cash</span>
                    <span class="payment-desc">Pay with cash</span>
                  </div>
                  <i class="fas fa-check payment-check"></i>
                </div>
              </label>
              <label class="payment-method-card">
                <input type="radio" name="payment" value="gcash">
                <div class="payment-card-content">
                  <div class="payment-icon-wrapper gcash-icon">
                    <span style="font-weight: bold; font-size: 24px;">GC</span>
                  </div>
                  <div class="payment-text">
                    <span class="payment-name">GCash</span>
                    <span class="payment-desc">Mobile wallet</span>
                  </div>
                  <i class="fas fa-check payment-check"></i>
                </div>
              </label>
              <label class="payment-method-card">
                <input type="radio" name="payment" value="card">
                <div class="payment-card-content">
                  <div class="payment-icon-wrapper card-icon">
                    <i class="fab fa-cc-visa"></i>
                  </div>
                  <div class="payment-text">
                    <span class="payment-name">Card</span>
                    <span class="payment-desc">Credit/Debit</span>
                  </div>
                  <i class="fas fa-check payment-check"></i>
                </div>
              </label>
            </div>
          </div>

          <div class="discount-section">
            <h3>Discount Card</h3>
            <div class="discount-options">
              <label class="discount-option">
                <input type="radio" name="discount_card_type" value="none" checked>
                <span>None</span>
              </label>
              <label class="discount-option">
                <input type="radio" name="discount_card_type" value="senior">
                <span>Senior (20%)</span>
              </label>
              <label class="discount-option">
                <input type="radio" name="discount_card_type" value="pwd">
                <span>PWD (20%)</span>
              </label>
            </div>
          </div>

          <div id="cashPaymentDetails" class="cash-details" style="display:none;">
            <h3>Cash Received</h3>
            <input type="number" id="cashReceivedInput" name="cash_received_amount" step="0.01" min="0" placeholder="‚Ç± 0.00" class="cash-input">
            <span id="changeDueSpan" class="change-amount"
            style="color:#ff0000; font-weight:700; font-size:18px;">
                ‚Ç±0.00
              </span>
              
          </div>

          <div class="payment-modal-actions">
            <button type="button" id="cancelPayment" class="btn-secondary">Cancel</button>
            <button type="submit" id="confirmPayment" class="btn-primary">Confirm Payment</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- Receipt Modal -->
  <div id="receiptModal" class="modal">
    <div class="receipt-modal-box">
      <div class="receipt-header">
        <button class="modal-close-btn" id="closeReceiptModal">
          <i class="fas fa-times"></i>
        </button>
        <button class="btn-print" id="printReceipt">
          <i class="fas fa-print"></i> Print Receipt
        </button>
      </div>
      <div class="receipt-content" id="receiptContent">
        <!-- Receipt content will be dynamically generated -->
      </div>
    </div>
  </div>

  <div id="logoutModal" class="modal">
    <div class="modal-box">
      <h3>Do you want to log out?</h3>
      <div style="margin-top:20px">
        <button id="confirmLogout">Yes</button>
        <button id="cancelLogout">No</button>
      </div>
    </div>
  </div>
  

  <!-- App script -->
  <script>
    const MENU = {
      "All Day Breakfast": {
        "All Day Pancake": { item_id: 1, price: 180, image: "assets/img/pancake.jpg" },
        "Breakfast Sandwich": { item_id: 2, price: 150, image: "assets/img//breakfast_sandwich.jpg" },
        "Eggs Benedict": { item_id: 3, price: 220, image: "assets/img//egg_benedict.jpg" }
      },
      "Nibblers": {
        "Mozarella Cheese Sticks": { item_id: 8, price: 85, image: "assets/img//cheese_sticks.jpg" },
        "Spring Rolls": { item_id: 9, price: 95, image: "assets/img//spring_rolls.jpg" }
      },
      "Specialties": {
        "Chicken Adobo": { item_id: 10, price: 250, image: "assets/img//chicken_adobo.jpg" },
        "Pork Sinigang": { item_id: 11, price: 270, image: "assets/img//pork_sinigang.jpg" }
      },
      "Pasta Pride": {
        "Pasta Puttanesca": { item_id: 12, price: 198, image: "assets/img//puttanesca.jpg" },
        "Mac and Cheese": { item_id: 13, price: 188, image: "assets/img//mac_cheese.jpg" },
        "Carbonara": { item_id: 14, price: 188, image: "assets/img//carbonara.jpg" },
        "Molo Blanca": { item_id: 15, price: 188, image: "assets/img//molo_blanca.jpg" },
        "Birthday Spaghetti": { item_id: 16, price: 188, image: "assets/img//spaghetti.jpg" },
        "Shrimp Aglio Spaghetti": { item_id: 17, price: 188, image: "assets/img//aglio_spaghetti.jpg" }
      },
      "Salads": {
        "Chicken Caesar Salad": { item_id: 18, price: 188, image: "assets/img//caesar_salad.jpg" },
        "Pan Fried Breaded Fish with Apple Garden Salad": { item_id: 19, price: 188, image: "assets/img//fish_salad.jpg" }
      },
      "Drinks": {
        "Cappuccino": { item_id: 20, price: 98, image: "assets/img//cappuccino.jpg" },
        "Latte": { item_id: 21, price: 118, image: "assets/img//latte.jpg" },
        "Iced Coffee": { item_id: 22, price: 148, image: "assets/img//iced_coffee.jpg" },
        "Espresso": { item_id: 23, price: 58, image: "assets/img//Espresso.jpg" }
      },
      "Desserts": {
        "Chocolate Lava Cake": { item_id: 24, price: 180, image: "assets/img//lava_cake.jpg" },
        "Vanilla Cheesecake": { item_id: 25, price: 150, image: "assets/img//cheesecake.jpg" }
      },
      "Soups": {
        "Pancit Molo": { item_id: 26, price: 238, image: "assets/img//pancit_molo.jpg" },
        "Beef Pochero": { item_id: 28, price: 328, image: "assets/img//pochero.jpg" },
        "Macaroni Soup": { item_id: 29, price: 238, image: "assets/img//macaroni_soup.jpg" }
      }
    };

    const VAT_RATE = 0.12;
    const DISCOUNT_MAP = { none: 0, senior: 0.20, pwd: 0.20 };

    // Product-specific add-ons and options
    const PRODUCT_ADDONS = {
      "All Day Breakfast": {
        addons: [
          { name: "Extra Eggs", value: "extra-eggs", price: 25 },
          { name: "Extra Bacon", value: "extra-bacon", price: 35 },
          { name: "Hash Browns", value: "hash-browns", price: 40 },
          { name: "Toast", value: "toast", price: 20 }
        ],
        sizes: true,
        modifiers: ["No-salt", "well-done", "Less-butter", "No-syrup"]
      },
      "Nibblers": {
        addons: [
          { name: "Extra Dip", value: "extra-dip", price: 15 },
          { name: "Extra Sauce", value: "extra-sauce", price: 10 }
        ],
        sizes: false,
        modifiers: ["extra-crispy", "less-salt"]
      },
      "Specialties": {
        addons: [
          { name: "Extra Rice", value: "extra-rice", price: 25 },
          { name: "Extra Sauce", value: "extra-sauce", price: 15 },
          { name: "Extra Vegetables", value: "extra-vegetables", price: 30 }
        ],
        sizes: false,
        modifiers: ["less-spicy", "no-onions", "extra-garlic"]
      },
      "Pasta Pride": {
        addons: [
          { name: "Extra Cheese", value: "extra-cheese", price: 25 },
          { name: "Extra Sauce", value: "extra-sauce", price: 20 },
          { name: "Extra Meat", value: "extra-meat", price: 50 },
          { name: "Garlic Bread", value: "garlic-bread", price: 45 }
        ],
        sizes: true,
        modifiers: ["less-cheese", "no-onions", "extra-garlic", "al-dente"]
      },
      "Salads": {
        addons: [
          { name: "Extra Dressing", value: "extra-dressing", price: 15 },
          { name: "Extra Protein", value: "extra-protein", price: 60 },
          { name: "Extra Vegetables", value: "extra-vegetables", price: 25 }
        ],
        sizes: true,
        modifiers: ["no-dressing", "dressing-on-side", "no-croutons"]
      },
      "Drinks": {
        addons: [
          { name: "Extra Shot", value: "extra-shot", price: 30 },
          { name: "Extra Sugar", value: "extra-sugar", price: 5 },
          { name: "Extra Cream", value: "extra-cream", price: 15 },
          { name: "Whipped Cream", value: "whipped-cream", price: 20 }
        ],
        sizes: true,
        modifiers: ["no-sugar", "less-ice", "no-ice", "decaf"]
      },
      "Desserts": {
        addons: [
          { name: "Extra Scoop", value: "extra-scoop", price: 40 },
          { name: "Whipped Cream", value: "whipped-cream", price: 20 },
          { name: "Caramel Drizzle", value: "caramel-drizzle", price: 25 },
          { name: "Chocolate Sauce", value: "chocolate-sauce", price: 25 }
        ],
        sizes: false,
        modifiers: ["less-sweet", "no-nuts"]
      },
      "Soups": {
        addons: [
          { name: "Extra Bread", value: "extra-bread", price: 20 },
          { name: "Extra Vegetables", value: "extra-vegetables", price: 25 },
          { name: "Extra Meat", value: "extra-meat", price: 50 }
        ],
        sizes: true,
        modifiers: ["less-spicy", "no-onions", "extra-garlic"]
      }
    };

    const productsGrid = document.getElementById('productsGrid');
    const invoiceItems = document.getElementById('invoiceItems');
    const invoiceSubtotal = document.getElementById('invoiceSubtotal');
    const invoiceTax = document.getElementById('invoiceTax');
    const invoiceTotal = document.getElementById('invoiceTotal');
    const doneBtn = document.getElementById('doneBtn');
    const paymentModal = document.getElementById('paymentModal');
    const modalCartItems = document.getElementById('modalCartItems');
    const modalTotalSpan = document.getElementById('modalTotal');
    const paymentForm = document.getElementById('paymentForm');
    const cancelPaymentBtn = document.getElementById('cancelPayment');
    const cashDetails = document.getElementById('cashPaymentDetails');
    const cashReceivedInput = document.getElementById('cashReceivedInput');
    const changeDueSpan = document.getElementById('changeDueSpan');
    const searchInput = document.getElementById('searchInput');
    
    // Product Modal Elements
    const productModal = document.getElementById('productModal');
    const modalProductImage = document.getElementById('modalProductImage');
    const modalProductName = document.getElementById('modalProductName');
    const modalProductCategory = document.getElementById('modalProductCategory');
    const modalProductBasePrice = document.getElementById('modalProductBasePrice');
    const productQuantity = document.getElementById('productQuantity');
    const decreaseQty = document.getElementById('decreaseQty');
    const increaseQty = document.getElementById('increaseQty');
    const addToOrderBtn = document.getElementById('addToOrderBtn');
    const closeProductModal = document.getElementById('closeProductModal');
    const cancelProductModal = document.getElementById('cancelProductModal');
    const specialInstructions = document.getElementById('specialInstructions');
    const charCount = document.getElementById('charCount');
    const breakdownBase = document.getElementById('breakdownBase');
    const breakdownAddons = document.getElementById('breakdownAddons');
    const breakdownQty = document.getElementById('breakdownQty');
    const breakdownTotal = document.getElementById('breakdownTotal');
    
    // Payment Modal Elements
    const closePaymentModal = document.getElementById('closePaymentModal');
    const modalSubtotal = document.getElementById('modalSubtotal');
    const modalVat = document.getElementById('modalVat');

    let cart = [];
    window.cart = cart;
    let activeCategory = 'all';
    let activeTab = 'popular';
    let currentProduct = null;
    // Get bill number from localStorage or start from 1
    let billNumberCounter = parseInt(localStorage.getItem('billNumberCounter')) || 1;
    let billNumber = '#' + billNumberCounter.toString().padStart(5, '0');
    
    function generateBillNumber() {
      billNumberCounter++;
      localStorage.setItem('billNumberCounter', billNumberCounter.toString());
      return '#' + billNumberCounter.toString().padStart(5, '0');
    }
    
    function getCategoryBadge(category) {
      const badgeMap = {
        "All Day Breakfast": { text: "Breakfast", class: "badge-black" },
        "Nibblers": { text: "Appetizer", class: "badge-gray" },
        "Specialties": { text: "Specialty", class: "badge-red" },
        "Pasta Pride": { text: "Pasta", class: "badge-black" },
        "Salads": { text: "Salad", class: "badge-gray" },
        "Drinks": { text: "Beverage", class: "badge-black" },
        "Desserts": { text: "Dessert", class: "badge-red" },
        "Soups": { text: "Soup", class: "badge-gray" }
      };
      return badgeMap[category] || { text: category, class: "badge-black" };
    }
    
    function getProductDescription(name, category) {
      const descriptions = {
        "All Day Breakfast": "Freshly prepared breakfast items served all day. Start your day right with our hearty morning favorites.",
        "Nibblers": "Perfect appetizers to start your meal. Crispy, flavorful bites that are great for sharing.",
        "Specialties": "Our signature dishes crafted with care. Special recipes that showcase our culinary expertise.",
        "Pasta Pride": "Authentic pasta dishes made with premium ingredients. Rich sauces and perfectly cooked noodles.",
        "Salads": "Fresh, crisp salads with premium ingredients. Healthy and delicious options for every palate.",
        "Drinks": "Refreshing beverages to complement your meal. From hot coffee to cool refreshments.",
        "Desserts": "Sweet treats to end your meal perfectly. Indulgent desserts made with quality ingredients.",
        "Soups": "Warm, comforting soups made from scratch. Hearty and flavorful bowls to warm your soul."
      };
      return descriptions[category] || "Delicious food item prepared with fresh ingredients and care.";
    }

    function renderProducts(category="all", searchTerm=""){
      productsGrid.innerHTML = "";
      const cats = category==="all" ? Object.keys(MENU) : [category];
      
      let items = [];
      cats.forEach(cat=>{
        Object.entries(MENU[cat]).forEach(([name,item])=>{
          if (!searchTerm || name.toLowerCase().includes(searchTerm.toLowerCase())) {
            items.push({name, item, cat});
          }
        });
      });

      items.forEach(({name, item, cat})=>{
        const div = document.createElement("div");
        div.className="product-card";
        const badgeInfo = getCategoryBadge(cat);
        const description = getProductDescription(name, cat);
        div.innerHTML=`
          <div class="product-badge ${badgeInfo.class}">${badgeInfo.text}</div>
          <div class="product-image">
            <img src="${item.image}" alt="${name}" onerror="this.style.display='none'">
          </div>
          <div class="product-overlay">
            <h3 class="product-name">${name}</h3>
            <p class="product-description">${description}</p>
            <div class="product-actions">
              <button class="order-btn" data-item-id="${item.item_id}" data-name="${name}" data-price="${item.price}" data-category="${cat}">
                ORDER
              </button>
            </div>
          </div>`;
        
        div.querySelector(".order-btn").addEventListener("click",()=>openProductModal({
          id:item.item_id,
          name,
          price:item.price,
          category:cat,
          image:item.image
        }));
        
        productsGrid.appendChild(div);
      });
    }

    function openProductModal(product){
      currentProduct = {...product};
      modalProductImage.src = product.image || '';
      modalProductImage.alt = product.name;
      modalProductName.textContent = product.name;
      modalProductCategory.textContent = product.category;
      modalProductBasePrice.textContent = `‚Ç±${product.price.toFixed(2)}`;
      productQuantity.value = 1;
      specialInstructions.value = '';
      charCount.textContent = '0';
      
      // Get product configuration
      const productConfig = PRODUCT_ADDONS[product.category] || {
        addons: [],
        sizes: false,
        modifiers: []
      };
      
      // Setup Size Options
      const sizeSection = document.getElementById('sizeSection');
      const requiredOptions = document.getElementById('requiredOptions');
      if(productConfig.sizes){
        sizeSection.style.display = 'block';
        requiredOptions.innerHTML = `
          <label class="option-radio">
            <input type="radio" name="size" value="small" data-price="0">
            <span>Small</span>
          </label>
          <label class="option-radio">
            <input type="radio" name="size" value="medium" data-price="0" checked>
            <span>Medium</span>
          </label>
          <label class="option-radio">
            <input type="radio" name="size" value="large" data-price="30">
            <span>Large (+‚Ç±30)</span>
          </label>
        `;
      } else {
        sizeSection.style.display = 'none';
        requiredOptions.innerHTML = '';
      }
      
      // Setup Add-ons
      const optionalAddons = document.getElementById('optionalAddons');
      if(productConfig.addons && productConfig.addons.length > 0){
        optionalAddons.innerHTML = productConfig.addons.map(addon => `
          <label class="option-radio">
           <input type="checkbox" style="margin-right:8px" name="addon" value="${addon.value}" data-price="${addon.price}">
            <span>${addon.name} P${addon.price}</span>
          </label>
        `).join('');
      } else {
        optionalAddons.innerHTML = productConfig.addons.map(addon => `
      <label class="option-radio">
       <input type="checkbox" style="margin-right:8px" name="addon" value="${addon.value}" data-price="${addon.price}">
        <span class="addon-label">${addon.name} P${addon.price}</span>
      </label>
    `).join('');

          }
      
      // Setup Modifiers
      const modifierButtons = document.getElementById('modifierButtons');
      const modifierLabels = {
        "no-sugar": "No Sugar",
        "less-salt": "Less Salt",
        "well-done": "Well Done",
        "no-onions": "No Onions",
        "extra-crispy": "Extra Crispy",
        "less-spicy": "Less Spicy",
        "extra-garlic": "Extra Garlic",
        "less-cheese": "Less Cheese",
        "al-dente": "Al Dente",
        "no-dressing": "No Dressing",
        "dressing-on-side": "Dressing on Side",
        "no-croutons": "No Croutons",
        "less-ice": "Less Ice",
        "no-ice": "No Ice",
        "decaf": "Decaf",
        "less-sweet": "Less Sweet",
        "no-nuts": "No Nuts",
        "less-butter": "Less Butter",
        "no-syrup": "No Syrup"
      };
      
      if(productConfig.modifiers && productConfig.modifiers.length > 0){
        modifierButtons.innerHTML = productConfig.modifiers.map(mod => `
          <button class="modifier-btn" data-modifier="${mod}">${modifierLabels[mod] || mod}</button>
        `).join('');
      } else {
        modifierButtons.innerHTML = '';
      }
      
      // Reset all selections
      document.querySelectorAll('input[name="size"]').forEach(r => {
        if(r.value === 'medium') r.checked = true;
      });
      document.querySelectorAll('input[name="addon"]').forEach(c => c.checked = false);
      document.querySelectorAll('.modifier-btn').forEach(b => b.classList.remove('active'));
      
      // Re-attach event listeners
      attachProductModalListeners();
      
      updatePriceBreakdown();
      productModal.style.display = 'flex';
    }
    
    function attachProductModalListeners(){
      // Size radio buttons
      document.querySelectorAll('input[name="size"]').forEach(radio => {
        radio.removeEventListener('change', updatePriceBreakdown);
        radio.addEventListener('change', updatePriceBreakdown);
      });
      
      // Add-on radio buttons
      document.querySelectorAll('input[name="addon"]').forEach(radio => {
        radio.removeEventListener('change', updatePriceBreakdown);
        radio.addEventListener('change', updatePriceBreakdown);
      });
      
      // Modifier buttons
      document.querySelectorAll('.modifier-btn').forEach(btn => {
        btn.removeEventListener('click', function(){});
        btn.addEventListener('click', () => {
          btn.classList.toggle('active');
        });
      });
    }
    
    function updatePriceBreakdown(){
      if(!currentProduct) return;
      
      const basePrice = parseFloat(currentProduct.price);
      const qty = parseInt(productQuantity.value) || 1;
      
      // Get selected size price (if size section is visible)
      const sizeSection = document.getElementById('sizeSection');
      let sizePrice = 0;
      if(sizeSection.style.display !== 'none'){
        const selectedSize = document.querySelector('input[name="size"]:checked');
        sizePrice = selectedSize ? parseFloat(selectedSize.dataset.price || 0) : 0;
      }
      
      // Get add-ons total (radio buttons - only one can be selected)
      let addonsTotal = 0;
      const selectedAddon = document.querySelector('input[name="addon"]:checked');
      if(selectedAddon) {
        addonsTotal = parseFloat(selectedAddon.dataset.price || 0);
      }
      
      const totalBase = basePrice + sizePrice;
      const totalAddons = addonsTotal * qty;
      const total = (totalBase * qty) + totalAddons;
      
      breakdownBase.textContent = `‚Ç±${totalBase.toFixed(2)}`;
      breakdownQty.textContent = `√ó ${qty}`;
      breakdownTotal.textContent = `‚Ç±${total.toFixed(2)}`;
      
      // Update button price
      const addToOrderPrice = document.getElementById('addToOrderPrice');
      if(addToOrderPrice) {
        addToOrderPrice.textContent = `‚Ç±${total.toFixed(2)}`;
      }
      
      // Enable/disable add button based on required options
      const sizeSectionVisible = sizeSection.style.display !== 'none';
      const hasRequiredSize = !sizeSectionVisible || document.querySelector('input[name="size"]:checked');
      addToOrderBtn.disabled = !hasRequiredSize;
    }
    
    function addToCart(product, quantity = 1, options = {}){
      const cartItem = {
        ...product,
        qty: quantity,
        size: options.size || null,
        addons: options.addons || [],
        modifiers: options.modifiers || [],
        specialInstructions: options.specialInstructions || ''
      };
      
      // Check if exact same item exists (same product, size, addons, modifiers)
      const existingIndex = cart.findIndex(i => 
        i.id === product.id && 
        i.size === cartItem.size &&
        JSON.stringify(i.addons) === JSON.stringify(cartItem.addons) &&
        JSON.stringify(i.modifiers) === JSON.stringify(cartItem.modifiers) &&
        i.specialInstructions === cartItem.specialInstructions
      );
      
      if(existingIndex >= 0){
        cart[existingIndex].qty += quantity;
      } else {
        cart.push(cartItem);
      }
      
      renderInvoice();
      productModal.style.display = 'none';
    }
    
    // Product Modal Event Listeners
    decreaseQty.addEventListener('click', () => {
      const qty = parseInt(productQuantity.value) || 1;
      if(qty > 1) productQuantity.value = qty - 1;
      updatePriceBreakdown();
    });
    
    increaseQty.addEventListener('click', () => {
      const qty = parseInt(productQuantity.value) || 1;
      if(qty < 99) productQuantity.value = qty + 1;
      updatePriceBreakdown();
    });
    
    productQuantity.addEventListener('input', () => {
      const qty = parseInt(productQuantity.value) || 1;
      if(qty < 1) productQuantity.value = 1;
      if(qty > 99) productQuantity.value = 99;
      updatePriceBreakdown();
    });
    
    // Event listeners are now attached dynamically in attachProductModalListeners()
    
    specialInstructions.addEventListener('input', (e) => {
      charCount.textContent = e.target.value.length;
    });
    
    addToOrderBtn.addEventListener('click', () => {
      if(!currentProduct) return;
      
      const qty = parseInt(productQuantity.value) || 1;
      const sizeSection = document.getElementById('sizeSection');
      const size = sizeSection.style.display !== 'none' 
        ? (document.querySelector('input[name="size"]:checked')?.value || 'medium')
        : null;
      const selectedAddon = document.querySelector('input[name="addon"]:checked');
      const addons = selectedAddon ? [{
        name: selectedAddon.value,
        price: parseFloat(selectedAddon.dataset.price || 0)
      }] : [];
      const modifiers = Array.from(document.querySelectorAll('.modifier-btn.active')).map(b => b.dataset.modifier);
      const instructions = specialInstructions.value.trim();
      
      addToCart(currentProduct, qty, { size, addons, modifiers, specialInstructions: instructions });
    });
    
    closeProductModal.addEventListener('click', () => {
      productModal.style.display = 'none';
    });
    
    cancelProductModal.addEventListener('click', () => {
      productModal.style.display = 'none';
    });
    
    productModal.addEventListener('click', (e) => {
      if(e.target === productModal) productModal.style.display = 'none';
    });
    
    // Keyboard shortcuts
    document.addEventListener('keydown', (e) => {
      if(productModal.style.display === 'flex' && e.key === 'Escape'){
        productModal.style.display = 'none';
      }
      if(paymentModal.style.display === 'flex' && e.key === 'Escape'){
        paymentModal.style.display = 'none';
      }
    });

    function renderInvoice(){
      const invoiceItemCount = document.getElementById('invoiceItemCount');
      const invoiceDiscountRow = document.getElementById('invoiceDiscountRow');
      const invoiceDiscount = document.getElementById('invoiceDiscount');
      
      invoiceItems.innerHTML = "";
      
      if(cart.length === 0) {
        invoiceItems.innerHTML = `
          <div class="empty-cart-message">
            <i class="fas fa-shopping-cart"></i>
            <p>No items in cart</p>
          </div>
        `;
        invoiceItemCount.textContent = '0';
        invoiceSubtotal.textContent = '‚Ç±0.00';
        invoiceTax.textContent = '‚Ç±0.00';
        invoiceTotal.textContent = '‚Ç±0.00';
        invoiceDiscountRow.style.display = 'none';
        return;
      }

      let subtotal=0;
      let itemCount = 0;

      cart.forEach((item, index)=>{
        // Calculate item total including add-ons
        const addonsTotal = (item.addons || []).reduce((sum, addon) => sum + addon.price, 0);
        const sizePrice = item.size === 'large' ? 30 : 0;
        const itemUnitPrice = item.price + sizePrice + addonsTotal;
        const itemTotal = itemUnitPrice * item.qty;
        subtotal += itemTotal;
        itemCount += item.qty;

        const invoiceItem = document.createElement("div");
        invoiceItem.className = "invoice-item";
        
        // Build customization details
        let customizationDetails = [];
        if(item.size) {
          customizationDetails.push(`<div class="invoice-item-customization-item"><strong>Size:</strong> ${item.size.charAt(0).toUpperCase() + item.size.slice(1)}</div>`);
        }
        if(item.addons && item.addons.length > 0){
          const addonNames = item.addons.map(a => {
            const addonName = a.name || a.value || 'Add-on';
            return addonName;
          }).join(', ');
          customizationDetails.push(`<div class="invoice-item-customization-item"><strong>Add-ons:</strong> ${addonNames}</div>`);
        }
        if(item.modifiers && item.modifiers.length > 0){
          const modifierLabels = {
            "no-sugar": "No Sugar",
            "less-salt": "Less Salt",
            "well-done": "Well Done",
            "no-onions": "No Onions",
            "extra-crispy": "Extra Crispy",
            "less-spicy": "Less Spicy",
            "extra-garlic": "Extra Garlic",
            "less-cheese": "Less Cheese",
            "al-dente": "Al Dente",
            "no-dressing": "No Dressing",
            "dressing-on-side": "Dressing on Side",
            "no-croutons": "No Croutons",
            "less-ice": "Less Ice",
            "no-ice": "No Ice",
            "decaf": "Decaf",
            "less-sweet": "Less Sweet",
            "no-nuts": "No Nuts",
            "less-butter": "Less Butter",
            "no-syrup": "No Syrup"
          };
          const modifierNames = item.modifiers.map(m => modifierLabels[m] || m).join(', ');
          customizationDetails.push(`<div class="invoice-item-customization-item"><strong>Modifiers:</strong> ${modifierNames}</div>`);
        }
        if(item.specialInstructions){
          customizationDetails.push(`<div class="invoice-item-customization-item"><strong>Note:</strong> ${item.specialInstructions}</div>`);
        }
        
        invoiceItem.innerHTML = `
          <div class="invoice-item-header">
            <div class="invoice-item-image">
              <img src="${item.image || ''}" alt="${item.name}" onerror="this.style.display='none'">
            </div>
            <div class="invoice-item-details">
              <div class="invoice-item-name">${item.name}</div>
              ${customizationDetails.length > 0 ? `<div class="invoice-item-customization">${customizationDetails.join('')}</div>` : ''}
            </div>
            <button class="remove-item-btn" data-item-index="${index}">
              <i class="fas fa-times"></i>
            </button>
          </div>
          <div class="invoice-item-footer">
            <span>Amount: ${item.qty}</span>
            <span class="invoice-item-price">‚Ç±${itemTotal.toFixed(2)}</span>
          </div>`;
        
        invoiceItem.querySelector(".remove-item-btn").addEventListener("click", () => {
          cart.splice(index, 1);
          renderInvoice();
        });

        invoiceItems.appendChild(invoiceItem);
      });

      const totals = computeTotals('none');
      invoiceItemCount.textContent = itemCount.toString();
      invoiceSubtotal.textContent = `‚Ç±${totals.subtotal.toFixed(2)}`;
      invoiceTax.textContent = `‚Ç±${totals.vat.toFixed(2)}`;
      invoiceTotal.textContent = `‚Ç±${totals.total.toFixed(2)}`;
      
      // Show/hide discount row
      if(totals.discountAmt > 0) {
        invoiceDiscountRow.style.display = 'flex';
        invoiceDiscount.textContent = `-‚Ç±${totals.discountAmt.toFixed(2)}`;
      } else {
        invoiceDiscountRow.style.display = 'none';
      }
    }

    document.querySelectorAll(".category-btn").forEach(btn=>{
      btn.addEventListener("click",()=>{
        document.querySelectorAll(".category-btn").forEach(b=>b.classList.remove("active"));
        btn.classList.add("active");
        activeCategory = btn.dataset.category;
        renderProducts(activeCategory, searchInput.value);
      });
    });

    document.querySelectorAll(".tab-btn").forEach(btn=>{
      btn.addEventListener("click",()=>{
        document.querySelectorAll(".tab-btn").forEach(b=>b.classList.remove("active"));
        btn.classList.add("active");
        activeTab = btn.dataset.tab;
        renderProducts(activeCategory, searchInput.value);
      });
    });

    searchInput.addEventListener("input", (e) => {
      renderProducts(activeCategory, e.target.value);
    });

    function computeTotals(discountType='none'){
      const subtotal = cart.reduce((s, i) => {
        const addonsTotal = (i.addons || []).reduce((sum, addon) => sum + addon.price, 0);
        const sizePrice = i.size === 'large' ? 30 : 0;
        const itemUnitPrice = i.price + sizePrice + addonsTotal;
        return s + (itemUnitPrice * i.qty);
      }, 0);
      const discountRate = DISCOUNT_MAP[discountType] || 0;
      const discountAmt = subtotal * discountRate;
      const taxable = Math.max(0, subtotal - discountAmt);
      const vat = taxable * VAT_RATE;
      const total = taxable + vat;
      return { subtotal, discountRate, discountAmt, vat, total };
    }

    doneBtn.addEventListener("click", () => {
      if (cart.length === 0) { alert("Your cart is empty."); return; }
      
      // If payment method was selected in sidebar, use it
      if(selectedPaymentMethod === 'cash') {
        // Cash payment - show payment modal with cash pre-selected
      } else if(selectedPaymentMethod === 'gcash' || selectedPaymentMethod === 'card') {
        // GCash and Card are handled in their respective modals
        return;
      }

      paymentForm.reset();
      cashDetails.style.display = "none";
      cashReceivedInput.value = "";
      changeDueSpan.textContent = "‚Ç±0.00";
      
      // Pre-select payment method if selected in sidebar
      if(selectedPaymentMethod === 'cash') {
        const cashRadio = paymentForm.querySelector('input[name="payment"][value="cash"]');
        if(cashRadio) cashRadio.checked = true;
        cashDetails.style.display = 'block';
        updateModalTotals();
      }

      modalCartItems.innerHTML = "";
      cart.forEach(item => {
        const addonsTotal = (item.addons || []).reduce((sum, addon) => sum + addon.price, 0);
        const sizePrice = item.size === 'large' ? 30 : 0;
        const itemUnitPrice = item.price + sizePrice + addonsTotal;
        const itemTotal = itemUnitPrice * item.qty;
        
        const cartItem = document.createElement("div");
        cartItem.className = "payment-cart-item";
        
        cartItem.innerHTML = `
          <div class="payment-item-image">
            <img src="${item.image || ''}" alt="${item.name}" onerror="this.style.display='none'">
          </div>
          <div class="payment-item-details">
            <div class="payment-item-name">${item.name}</div>
            ${item.qty > 1 ? `<div class="payment-item-meta">x${item.qty}</div>` : '<div class="payment-item-meta">x1</div>'}
          </div>
          <div class="payment-item-price">‚Ç±${itemTotal.toFixed(2)}</div>
        `;
        modalCartItems.appendChild(cartItem);
      });

      // Reset discount to none when opening modal
      const noneDiscount = paymentForm.querySelector('input[name="discount_card_type"][value="none"]');
      if(noneDiscount) noneDiscount.checked = true;
      
      const t = computeTotals('none');
      modalSubtotal.textContent = `‚Ç±${t.subtotal.toFixed(2)}`;
      modalVat.textContent = `‚Ç±${t.vat.toFixed(2)}`;
      modalTotalSpan.textContent = `‚Ç±${t.total.toFixed(2)}`;
      
      // Hide discount row initially
      const discountRow = document.getElementById('discountRow');
      if(discountRow) discountRow.style.display = 'none';

      paymentModal.style.display = "flex";
    });
    
    closePaymentModal.addEventListener("click", () => {
      paymentModal.style.display = "none";
    });

    paymentForm.querySelectorAll('input[name="payment"]').forEach(r=>{
      r.addEventListener('change', ()=>{
        const method = getSelectedPayment();
        cashDetails.style.display = method === 'cash' ? 'block' : 'none';
        updateModalTotals();
      });
    });

    paymentForm.querySelectorAll('input[name="discount_card_type"]').forEach(r=>{
      r.addEventListener('change', updateModalTotals);
    });

    cashReceivedInput.addEventListener('input', ()=>{
      const t = computeTotals(getSelectedDiscount());
      const cash = parseFloat(cashReceivedInput.value || '0');
      const change = Math.max(0, cash - t.total);
      changeDueSpan.textContent = `‚Ç±${change.toFixed(2)}`;
      updateModalTotals();
    });

    function updateModalTotals(){
      const discountType = getSelectedDiscount();
      const t = computeTotals(discountType);
      modalSubtotal.textContent = `‚Ç±${t.subtotal.toFixed(2)}`;
      modalVat.textContent = `‚Ç±${t.vat.toFixed(2)}`;
      modalTotalSpan.textContent = `‚Ç±${t.total.toFixed(2)}`;
      
      // Show/hide discount row
      const discountRow = document.getElementById('discountRow');
      const discountLabel = document.getElementById('discountLabel');
      const modalDiscount = document.getElementById('modalDiscount');
      
      if(t.discountAmt > 0) {
        discountRow.style.display = 'flex';
        const discountName = discountType === 'senior' ? 'Senior (20%)' : discountType === 'pwd' ? 'PWD (20%)' : 'Discount';
        discountLabel.textContent = discountName;
        modalDiscount.textContent = `-‚Ç±${t.discountAmt.toFixed(2)}`;
      } else {
        discountRow.style.display = 'none';
      }

      if(getSelectedPayment()==='cash'){
        const cash = parseFloat(cashReceivedInput.value || '0');
        const change = Math.max(0, cash - t.total);
        changeDueSpan.textContent = `‚Ç±${change.toFixed(2)}`;
      }else{
        changeDueSpan.textContent = "‚Ç±0.00";
      }
    }

    function getSelectedPayment(){
      const r = paymentForm.querySelector('input[name="payment"]:checked');
      return r ? r.value : null;
    }
    function getSelectedDiscount(){
      const r = paymentForm.querySelector('input[name="discount_card_type"]:checked');
      return r ? r.value : 'none';
    }

    cancelPaymentBtn.addEventListener("click", ()=> paymentModal.style.display = "none");
    paymentModal.addEventListener("click", (e) => { if (e.target === paymentModal) paymentModal.style.display = "none"; });
    
    // Payment method selection in invoice sidebar
    let selectedPaymentMethod = null;
    let gcashTimerInterval = null;
    let selectedAccountType = null;
    
    document.querySelectorAll('.payment-method-btn-sidebar').forEach(btn => {
      btn.addEventListener('click', () => {
        const method = btn.dataset.method;
        selectedPaymentMethod = method;
        
        // Remove active class from all buttons
        document.querySelectorAll('.payment-method-btn-sidebar').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        
        if(method === 'cash') {
          // Cash payment - proceed directly to payment modal
          if (cart.length === 0) {
            alert("Your cart is empty.");
            return;
          }
          doneBtn.click();
        } else if(method === 'gcash') {
          // GCash payment - show QR code modal
          if (cart.length === 0) {
            alert("Your cart is empty.");
            return;
          }
          openGCashModal();
        } else if(method === 'card') {
          // Card payment - show card payment modal
          if (cart.length === 0) {
            alert("Your cart is empty.");
            return;
          }
          openCardModal();
        }
      });
    });
    
    function openGCashModal() {
      const gcashModal = document.getElementById('gcashModal');
      gcashModal.style.display = 'flex';
      
      // Start 10 second timer
      let timeLeft = 10;
      const timerSpan = document.getElementById('gcashTimer');
      timerSpan.textContent = timeLeft;
      
      gcashTimerInterval = setInterval(() => {
        timeLeft--;
        timerSpan.textContent = timeLeft;
        
        if(timeLeft <= 0) {
          clearInterval(gcashTimerInterval);
          timerSpan.textContent = '0';
        }
      }, 1000);
    }
    
    function closeGCashModal() {
      const gcashModal = document.getElementById('gcashModal');
      gcashModal.style.display = 'none';
      if(gcashTimerInterval) {
        clearInterval(gcashTimerInterval);
        gcashTimerInterval = null;
      }
    }
    
    function openCardModal() {
      const cardModal = document.getElementById('cardModal');
      cardModal.style.display = 'flex';

      // Get current total amount
      const discountType = getSelectedDiscount() || 'none';
      const totals = computeTotals(discountType);

      // Populate the total amount field
      document.getElementById('totalAmount').value = `‚Ç±${totals.total.toFixed(2)}`;

      // Clear form fields
      document.getElementById('accountNumber').value = '';
      document.getElementById('cardPin').value = '';
    }
    
    function closeCardModal() {
      const cardModal = document.getElementById('cardModal');
      cardModal.style.display = 'none';
      selectedAccountType = null;
      cardPaymentStep = 1;
    }
    
    // GCash Modal Event Listeners
    document.getElementById('closeGCashModal').addEventListener('click', closeGCashModal);
    document.getElementById('gcashCancel').addEventListener('click', () => {
      closeGCashModal();
      // Reopen payment modal if it was open before
      if(selectedPaymentMethod === 'gcash' || paymentModal.style.display === 'flex') {
        paymentModal.style.display = 'flex';
      }
    });
    document.getElementById('gcashSuccess').addEventListener('click', async () => {
      closeGCashModal();
      // Process GCash payment directly
      if (cart.length === 0) {
        alert("Your cart is empty.");
        return;
      }
      
      // Get discount from payment modal if it was open
      const discountType = getSelectedDiscount() || 'none';
      const t = computeTotals(discountType);
      
      // Save order to Firebase
      try {
        const { addDoc, collection, serverTimestamp } = await import("https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js");
        
        const safeCart = window.cart.map(i => ({
          id: i.id,
          name: i.name,
          price: i.price,
          qty: i.qty,
          category: i.category,
          size: i.size,
          addons: i.addons,
          modifiers: i.modifiers,
          specialInstructions: i.specialInstructions,
          image: i.image
        }));

        const customerName = document.getElementById('customerName')?.value || '';
        const tableSelect = document.getElementById('tableSelect')?.value || '';
        const tableNumber = tableSelect ? `Table ${tableSelect}` : '';
        
        const orderRef = await addDoc(collection(window.Firebase.db, "orders"), {
          items: safeCart,
          totals: t,
          paymentMethod: 'gcash',
          discountType,
          customerName,
          tableNumber: tableNumber,
          billNumber: billNumber,
          cashierUid: window.Firebase.auth.currentUser?.uid || 'anonymous',
          createdAt: serverTimestamp()
        });

        await addDoc(collection(window.Firebase.db, "logs"), {
          whoUid: window.Firebase.auth.currentUser?.uid || 'anonymous',
          action: "ORDER_CREATED",
          details: { orderId: orderRef.id, total: t.total, paymentMethod: 'gcash' },
          createdAt: serverTimestamp()
        });

        // Show receipt
        showReceipt({
          items: safeCart,
          totals: t,
          paymentMethod: 'gcash',
          discountType,
          customerName,
          tableNumber,
          billNumber,
          orderId: orderRef.id
        });

        // Clear cart and reset
        cart.length = 0;
        billNumber = generateBillNumber();
        document.getElementById('billNumber').textContent = billNumber;
        document.getElementById('customerName').value = '';
        document.getElementById('tableSelect').value = '';
        renderInvoice();
        selectedPaymentMethod = null;
        document.querySelectorAll('.payment-method-btn-sidebar').forEach(b => b.classList.remove('active'));
        paymentModal.style.display = "none";
      } catch(err) {
        console.error("Error saving order:", err);
        alert("Failed to save order. Check console for details.");
      }
    });
    document.getElementById('gcashFailed').addEventListener('click', () => {
      alert('Payment failed. Please try again.');
      closeGCashModal();
    });
    
    // Card Modal Event Listeners
    document.getElementById('closeCardModal').addEventListener('click', closeCardModal);
    document.getElementById('cardCancel').addEventListener('click', () => {
      closeCardModal();
      // Reopen payment modal if it was open before
      if(selectedPaymentMethod === 'card' || paymentModal.style.display === 'flex') {
        paymentModal.style.display = 'flex';
      }
    });
    
    document.querySelectorAll('.account-type-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        document.querySelectorAll('.account-type-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        selectedAccountType = btn.dataset.type;
        cardPaymentStep = 2;
        document.getElementById('pinGroup').style.display = 'block';
        document.getElementById('cardPin').value = '';
      });
    });
    
    document.getElementById('cardPin').addEventListener('input', (e) => {
      const pin = e.target.value.replace(/\D/g, ''); // Only numbers
      e.target.value = pin;
      if(pin.length === 6) {
        // Skip amount entry, go directly to processing payment
        cardPaymentStep = 3;
        processCardPayment();
      }
    });

    document.getElementById('cardConfirm').addEventListener('click', () => {
      const accountNumber = document.getElementById('accountNumber').value.trim();
      const cardPin = document.getElementById('cardPin').value.trim();

      if(!accountNumber) {
        alert('Please enter account number.');
        return;
      }

      if(!cardPin || cardPin.length !== 6) {
        alert('Please enter a valid 6-digit PIN.');
        return;
      }

      processCardPayment();
    });
    
    async function processCardPayment() {
      if (cart.length === 0) {
        alert("Your cart is empty.");
        return;
      }
      
      // Get discount from payment modal if it was open
      const discountType = getSelectedDiscount() || 'none';
      const totals = computeTotals(discountType);
      
      // Save order to Firebase
      try {
        const { addDoc, collection, serverTimestamp } = await import("https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js");
        
        const safeCart = window.cart.map(i => ({
          id: i.id,
          name: i.name,
          price: i.price,
          qty: i.qty,
          category: i.category,
          size: i.size,
          addons: i.addons,
          modifiers: i.modifiers,
          specialInstructions: i.specialInstructions,
          image: i.image
        }));

        const customerName = document.getElementById('customerName')?.value || '';
        const tableSelect = document.getElementById('tableSelect')?.value || '';
        const tableNumber = tableSelect ? `Table ${tableSelect}` : '';
        
        const orderRef = await addDoc(collection(window.Firebase.db, "orders"), {
          items: safeCart,
          totals: totals,
          paymentMethod: 'card',
          discountType: discountType,
          accountType: selectedAccountType,
          customerName,
          tableNumber: tableNumber,
          billNumber: billNumber,
          cashierUid: window.Firebase.auth.currentUser?.uid || 'anonymous',
          createdAt: serverTimestamp()
        });

        await addDoc(collection(window.Firebase.db, "logs"), {
          whoUid: window.Firebase.auth.currentUser?.uid || 'anonymous',
          action: "ORDER_CREATED",
          details: { orderId: orderRef.id, total: totals.total, paymentMethod: 'card' },
          createdAt: serverTimestamp()
        });

        // Show receipt
        showReceipt({
          items: safeCart,
          totals: totals,
          paymentMethod: 'card',
          discountType: discountType,
          accountType: selectedAccountType,
          customerName,
          tableNumber,
          billNumber,
          orderId: orderRef.id
        });

        // Clear cart and reset
        closeCardModal();
        cart.length = 0;
        billNumber = generateBillNumber();
        document.getElementById('billNumber').textContent = billNumber;
        document.getElementById('customerName').value = '';
        document.getElementById('tableSelect').value = '';
        renderInvoice();
        selectedPaymentMethod = null;
        document.querySelectorAll('.payment-method-btn-sidebar').forEach(b => b.classList.remove('active'));
        paymentModal.style.display = "none";
      } catch(err) {
        console.error("Error saving order:", err);
        alert("Failed to save order. Check console for details.");
      }
    }
    
    // Card payment is now processed automatically after PIN entry
    
    // Close modals when clicking outside
    document.getElementById('gcashModal').addEventListener('click', (e) => {
      if(e.target.id === 'gcashModal') closeGCashModal();
    });
    document.getElementById('cardModal').addEventListener('click', (e) => {
      if(e.target.id === 'cardModal') closeCardModal();
    });

    // Receipt Modal Functions
    function showReceipt(orderData) {
      const receiptContent = document.getElementById('receiptContent');
      const receiptModal = document.getElementById('receiptModal');
      
      const itemsHtml = orderData.items.map(item => {
        const addonsTotal = (item.addons || []).reduce((sum, addon) => sum + addon.price, 0);
        const sizePrice = item.size === 'large' ? 30 : 0;
        const itemUnitPrice = item.price + sizePrice + addonsTotal;
        const itemTotal = itemUnitPrice * item.qty;
        
        let itemDetails = item.name;
        if(item.size) itemDetails += ` (${item.size})`;
        if(item.addons && item.addons.length > 0) {
          itemDetails += ` + ${item.addons.map(a => a.name || a.value).join(', ')}`;
        }
        
        return `
          <div class="receipt-item">
            <div class="receipt-item-name">${itemDetails}</div>
            <div class="receipt-item-qty">${item.qty}x</div>
            <div class="receipt-item-price">‚Ç±${itemTotal.toFixed(2)}</div>
          </div>
        `;
      }).join('');
      
      const paymentMethodLabels = {
        'cash': 'Cash',
        'gcash': 'GCash',
        'card': 'Card'
      };
      
      const discountLabels = {
        'none': '',
        'senior': 'Senior (20%)',
        'pwd': 'PWD (20%)'
      };
      
      const receiptHtml = `
        <div class="receipt-company">
          <h2>LitLatte</h2>
          <p>Point of Sale System</p>
        </div>
        <div class="receipt-info">
          <div class="receipt-row">
            <span>Bill Number:</span>
            <span>${orderData.billNumber}</span>
          </div>
          <div class="receipt-row">
            <span>Date:</span>
            <span>${new Date().toLocaleString('en-US', { 
              year: 'numeric', 
              month: 'short', 
              day: 'numeric',
              hour: '2-digit',
              minute: '2-digit'
            })}</span>
          </div>
          ${orderData.customerName ? `<div class="receipt-row"><span>Customer:</span><span>${orderData.customerName}</span></div>` : ''}
          ${orderData.tableNumber ? `<div class="receipt-row"><span>Table:</span><span>${orderData.tableNumber}</span></div>` : ''}
        </div>
        <div class="receipt-divider"></div>
        <div class="receipt-items">
          ${itemsHtml}
        </div>
        <div class="receipt-divider"></div>
        <div class="receipt-totals">
          <div class="receipt-total-row">
            <span>Subtotal:</span>
            <span>‚Ç±${orderData.totals.subtotal.toFixed(2)}</span>
          </div>
          ${orderData.totals.discountAmt > 0 ? `
            <div class="receipt-total-row">
              <span>Discount (${discountLabels[orderData.discountType]}):</span>
              <span>-‚Ç±${orderData.totals.discountAmt.toFixed(2)}</span>
            </div>
          ` : ''}
          <div class="receipt-total-row">
            <span>VAT (12%):</span>
            <span>‚Ç±${orderData.totals.vat.toFixed(2)}</span>
          </div>
          <div class="receipt-total-row receipt-grand-total">
            <span>Total:</span>
            <span>‚Ç±${orderData.totals.total.toFixed(2)}</span>
          </div>
        </div>
        <div class="receipt-divider"></div>
        <div class="receipt-payment">
          <div class="receipt-row">
            <span>Payment Method:</span>
            <span>${paymentMethodLabels[orderData.paymentMethod] || orderData.paymentMethod}</span>
          </div>
          ${orderData.paymentMethod === 'cash' ? `
            <div class="receipt-row">
              <span>Cash Received:</span>
              <span>‚Ç±${orderData.cashReceived.toFixed(2)}</span>
            </div>
            <div class="receipt-row">
              <span>Change:</span>
              <span>‚Ç±${orderData.change.toFixed(2)}</span>
            </div>
          ` : ''}
          ${orderData.paymentMethod === 'card' && orderData.accountType ? `
            <div class="receipt-row">
              <span>Account Type:</span>
              <span>${orderData.accountType.charAt(0).toUpperCase() + orderData.accountType.slice(1)}</span>
            </div>
          ` : ''}
        </div>
        <div class="receipt-footer">
          <p>Thank you for your order!</p>
          <p>Visit us again soon</p>
        </div>
      `;
      
      receiptContent.innerHTML = receiptHtml;
      openReceiptModal();
    }
    
    function closeReceiptModal() {
      const receiptModal = document.getElementById('receiptModal');
      receiptModal.style.display = 'none';
    }
    
    document.getElementById('closeReceiptModal').addEventListener('click', closeReceiptModal);
    document.getElementById('printReceipt').addEventListener('click', () => {
      window.print();
    });
    
    document.getElementById('receiptModal').addEventListener('click', (e) => {
      if(e.target.id === 'receiptModal') closeReceiptModal();
    });

    // Initialize bill number
    document.getElementById('billNumber').textContent = billNumber;
    
    renderProducts();
    renderInvoice();
  </script>

  <script type="module">
    import { addDoc, collection, serverTimestamp }
      from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";

    paymentForm.addEventListener('submit', async (e) => {
      e.preventDefault();

      if(window.cart.length===0){
        alert('Cart is empty.');
        return;
      }

      let method = getSelectedPayment();
      
      // If payment method was selected in sidebar, use it
      if(!method && selectedPaymentMethod) {
        method = selectedPaymentMethod;
        // Pre-select in form
        const paymentRadio = paymentForm.querySelector(`input[name="payment"][value="${method}"]`);
        if(paymentRadio) paymentRadio.checked = true;
      }
      
      if(!method){
        alert('Choose a payment method.');
        return;
      }

      const discountType = getSelectedDiscount();
      const t = computeTotals(discountType);

      // Handle different payment methods
      if(method === 'gcash') {
        // Close payment modal and open GCash modal
        paymentModal.style.display = "none";
        openGCashModal();
        return;
      } else if(method === 'card') {
        // Close payment modal and open Card modal
        paymentModal.style.display = "none";
        openCardModal();
        return;
      } else if(method === 'cash') {
        // Process cash payment
        const cash = parseFloat(cashReceivedInput.value || '0');
        if(cash < t.total){
          alert('Cash received is less than total.');
          return;
        }
        
        const change = cash - t.total;
        
        // Process cash payment
        try {
          const safeCart = window.cart.map(i => ({
            id: i.id,
            name: i.name,
            price: i.price,
            qty: i.qty,
            category: i.category,
            size: i.size,
            addons: i.addons,
            modifiers: i.modifiers,
            specialInstructions: i.specialInstructions,
            image: i.image
          }));

          const customerName = document.getElementById('customerName')?.value || '';
          const tableSelect = document.getElementById('tableSelect')?.value || '';
          const tableNumber = tableSelect ? `Table ${tableSelect}` : '';
          
          const orderRef = await addDoc(collection(window.Firebase.db, "orders"), {
            items: safeCart,
            totals: t,
            paymentMethod: 'cash',
            discountType,
            customerName,
            tableNumber: tableNumber,
            billNumber: billNumber,
            cashReceived: cash,
            change: change,
            cashierUid: window.Firebase.auth.currentUser?.uid || 'anonymous',
            createdAt: serverTimestamp()
          });

          await addDoc(collection(window.Firebase.db, "logs"), {
            whoUid: window.Firebase.auth.currentUser?.uid || 'anonymous',
            action: "ORDER_CREATED",
            details: { orderId: orderRef.id, total: t.total, paymentMethod: 'cash' },
            createdAt: serverTimestamp()
          });

          // Show receipt
          showReceipt({
            items: safeCart,
            totals: t,
            paymentMethod: 'cash',
            discountType,
            customerName,
            tableNumber,
            billNumber,
            cashReceived: cash,
            change: change,
            orderId: orderRef.id
          });

          
          cart.length = 0;
          billNumber = generateBillNumber();
          document.getElementById('billNumber').textContent = billNumber;
          document.getElementById('customerName').value = '';
          document.getElementById('tableSelect').value = '';
          selectedPaymentMethod = null;
          document.querySelectorAll('.payment-method-btn-sidebar').forEach(b => b.classList.remove('active'));
          renderInvoice();
          paymentModal.style.display = "none";

        } catch(err) {
          console.error("Error saving order:", err);
          alert("Failed to save order. Check console for details.");
        }
      }
    });
  </script>

  <script>
    let receiptAutoCloseTimer = null;
  
    function openReceiptModal() {
      const receiptModal = document.getElementById('receiptModal');
      receiptModal.style.display = 'flex';
  
      // Start 5-second auto close
      receiptAutoCloseTimer = setTimeout(() => {
        closeReceiptModal();
      }, 5000);
    }
  
    function closeReceiptModal() {
      const receiptModal = document.getElementById('receiptModal');
      receiptModal.style.display = 'none';
  
      // Clear timer if closed manually
      if (receiptAutoCloseTimer) {
        clearTimeout(receiptAutoCloseTimer);
        receiptAutoCloseTimer = null;
      }
    }
  
    // Close button
    document.getElementById('closeReceiptModal').addEventListener('click', closeReceiptModal);
  
    // Click outside receipt
    document.getElementById('receiptModal').addEventListener('click', (e) => {
      if (e.target.id === 'receiptModal') {
        closeReceiptModal();
      }
    });

    lucide.createIcons();

    const params = new URLSearchParams(window.location.search);

if (params.get("viewReceipt") === "true") {
  const receipt = JSON.parse(localStorage.getItem("viewReceipt"));
  if (receipt) {
    showReceiptFromManager(receipt);
  }
}

function showReceiptFromManager(order) {
  const receiptContent = document.getElementById("receiptContent");

  receiptContent.innerHTML = `
    <h3>Receipt</h3>
    <p><strong>Customer:</strong> ${order.customerName || "Walk-in"}</p>
    <p><strong>Date:</strong> ${new Date(order.createdAt.seconds * 1000).toLocaleString()}</p>
    <hr>
    ${order.items.map(i => `
      <div>${i.qty} √ó ${i.name} ‚Äî ‚Ç±${(i.qty * i.price).toFixed(2)}</div>
    `).join("")}
    <hr>
    <strong>Total: ‚Ç±${order.totals.total.toFixed(2)}</strong>
  `;

  document.getElementById("receiptModal").style.display = "flex";
}

logoutBtn.onclick = () => {
  document.getElementById("logoutModal").style.display = "flex";
};

confirmLogout.onclick = () => {
  localStorage.removeItem("loggedIn");
  window.location.href = "index.html";
};

cancelLogout.onclick = () => {
  document.getElementById("logoutModal").style.display = "none";
};


  </script>
  
</body>
</html>
