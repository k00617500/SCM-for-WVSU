<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Café POS</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="assets/css/styles.css">


  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
    import { getAnalytics } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-analytics.js";
    import { getAuth } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js";
    import { getFirestore } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyAd7ZD-YonKHor0twOWSyPAE6ix9LXLeGI",
      authDomain: "pos2-27d04.firebaseapp.com",
      projectId: "pos2-27d04",
      storageBucket: "pos2-27d04.firebasestorage.app",
      messagingSenderId: "394720721108",
      appId: "1:394720721108:web:b0d8decc48bc01abfba341",
      measurementId: "G-KLWC55M3BW"
    };

    const app = initializeApp(firebaseConfig);
    const analytics = getAnalytics(app);
    const auth = getAuth(app);
    const db = getFirestore(app);

    window.Firebase = { app, analytics, auth, db };

 
    if (localStorage.getItem('loggedIn') !== 'true') {
      window.location.href = "login.html";
    }
  </script>
</head>
<script>
  document.addEventListener("DOMContentLoaded", () => {
    const managerBtn = document.getElementById("managerBtn");
    const MANAGER_PIN = "1234";

    if (managerBtn) {
      managerBtn.addEventListener("click", () => {
        const pin = prompt("Enter Manager PIN:");

        if (pin === null) return;

        if (pin !== MANAGER_PIN) {
          alert("❌ Incorrect Manager PIN");
          return;
        }


        window.location.href = "manager.html";
      });
    }
  });
</script>

<body>
  <header>
    <h1>Café POS</h1>
    <div class="manager-area">
    <button id="managerBtn" class="manager-btn">Manager</button>
    </div>
  </header>

  <div class="wrap">

    <div class="cart">
      <section class="panel">
        <h2>Cart items</h2>
        <div class="content">
          <div class="cart-items" id="cartItems"></div>
          <button class="remove" id="clearCart">Clear cart</button>
        </div>
      </section>
      <section class="cart-summary">
        <p><strong>Total: ₱<span id="cart-total">0.00</span></strong></p>
        <button type="button" id="doneBtn" class="done-btn">Done</button>
      </section>
    </div>


    <div class="category-bar">
      <button data-category="all" class="active">All</button>
      <button data-category="All Day Breakfast">All Day Breakfast</button>
      <button data-category="Nibblers">Nibblers</button>
      <button data-category="Specialties">Specialties</button>
      <button data-category="Pasta Pride">Pasta Pride</button>
      <button data-category="Salads">Salads</button>
      <button data-category="Drinks">Drinks</button>
      <button data-category="Desserts">Desserts</button>
      <button data-category="Soups">Soups</button>
    </div>


    <div class="products grid" id="productsGrid"></div>
  </div>

  <div id="paymentModal" class="modal">
    <div class="box">
      <h2>Your Cart</h2>
      <div id="modalCartItems"></div>
      <p><strong>Total: ₱<span id="modalTotal">0.00</span></strong></p>

      <h3>Choose payment method</h3>
      <form id="paymentForm">
        <label><input type="radio" name="payment" value="cash" required> Cash</label><br>
        <label><input type="radio" name="payment" value="card"> Card</label><br>
        <label><input type="radio" name="payment" value="gcash"> GCash</label><br><br>

        <h3>Discount card?</h3>
        <label><input type="radio" name="discount_card_type" value="none" checked> No Discount Card</label><br>
        <label><input type="radio" name="discount_card_type" value="senior"> Senior Citizen</label><br>
        <label><input type="radio" name="discount_card_type" value="pwd"> PWD</label><br><br>

        <div id="cashPaymentDetails" style="display:none; margin-top: 15px;">
          <label for="cashReceivedInput">Cash Received (₱):</label>
          <input type="number" id="cashReceivedInput" name="cash_received_amount" step="0.01" min="0" placeholder="Enter amount received" style="width:100%;padding:8px;margin-top:5px;box-sizing:border-box;">
          <p style="margin-top:10px;">Change Due: ₱<span id="changeDueSpan">0.00</span></p>
        </div>

        <div style="margin-top:12px; display:flex; gap:8px; justify-content:flex-end;">
          <button type="submit" id="confirmPayment" class="primary">Confirm payment</button>
          <button type="button" id="cancelPayment">Cancel</button>
        </div>
      </form>
    </div>
  </div>


  <script>
    const MENU = {
      "All Day Breakfast": {
        "All Day Pancake": { item_id: 1, price: 180, image: "assets/img/pancake.jpg" },
        "Breakfast Sandwich": { item_id: 2, price: 150, image: "assets/img//breakfast_sandwich.jpg" },
        "Egg Benedict": { item_id: 3, price: 220, image: "assets/img//egg_benedict.jpg" }
      },
      "Nibblers": {
        "Cheese Sticks": { item_id: 8, price: 85, image: "assets/img//cheese_sticks.jpg" },
        "Spring Rolls": { item_id: 9, price: 95, image: "assets/img//spring_rolls.jpg" }
      },
      "Specialties": {
        "Chicken Adobo": { item_id: 10, price: 250, image: "assets/img//chicken_adobo.jpg" },
        "Pork Sinigang": { item_id: 11, price: 270, image: "assets/img//pork_sinigang.jpg" }
      },
      "Pasta Pride": {
        "Pasta Puttanesca": { item_id: 12, price: 198, image: "assets/img//puttanesca.jpg" },
        "Mac and Cheese": { item_id: 13, price: 188, image: "assets/img//mac_cheese.jpg" },
        "Carbonara": { item_id: 14, price: 188, image: "assets/img//carbonara.jpg" },
        "Molo Blanca": { item_id: 15, price: 188, image: "assets/img//molo_blanca.jpg" },
        "Birthday Spaghetti": { item_id: 16, price: 188, image: "assets/img//spaghetti.jpg" },
        "Shrimp Aglio Spaghetti": { item_id: 17, price: 188, image: "assets/img//aglio_spaghetti.jpg" }
      },
      "Salads": {
        "Chicken Caesar Salad": { item_id: 18, price: 188, image: "assets/img//caesar_salad.jpg" },
        "Pan Fried Breaded Fish with Apple Garden Salad": { item_id: 19, price: 188, image: "assets/img//fish_salad.jpg" }
      },
      "Drinks": {
        "Cappuccino": { item_id: 20, price: 98, image: "assets/img//cappuccino.jpg" },
        "Latte": { item_id: 21, price: 118, image: "assets/img//latte.jpg" },
        "Iced Coffee": { item_id: 22, price: 148, image: "assets/img//iced_coffee.jpg" },
        "Espresso": { item_id: 23, price: 58, image: "assets/img//Espresso.jpg" }
      },
      "Desserts": {
        "Chocolate Lava Cake": { item_id: 24, price: 180, image: "assets/img//lava_cake.jpg" },
        "Vanilla Cheesecake": { item_id: 25, price: 150, image: "assets/img//cheesecake.jpg" }
      },
      "Soups": {
        "Pancit Molo": { item_id: 26, price: 238, image: "assets/img//pancit_molo.jpg" },
        "Kansi Linaga": { item_id: 27, price: 130, image: "assets/img//kansi_linaga.jpg" },
        "Beef Pochero": { item_id: 28, price: 328, image: "assets/img//pochero.jpg" },
        "Macaroni Soup": { item_id: 29, price: 238, image: "assets/img//macaroni_soup.jpg" }
      }
    };

    const VAT_RATE = 0.12;
    const DISCOUNT_MAP = { none: 0, senior: 0.20, pwd: 0.20 };

    const productsGrid = document.getElementById('productsGrid');
    const cartItemsEl = document.getElementById('cartItems');
    const cartTotalEl = document.getElementById('cart-total');
    const clearCartBtn = document.getElementById('clearCart');
    const doneBtn = document.getElementById('doneBtn');
    const paymentModal = document.getElementById('paymentModal');
    const modalCartItems = document.getElementById('modalCartItems');
    const modalTotalSpan = document.getElementById('modalTotal');
    const paymentForm = document.getElementById('paymentForm');
    const cancelPaymentBtn = document.getElementById('cancelPayment');
    const cashDetails = document.getElementById('cashPaymentDetails');
    const cashReceivedInput = document.getElementById('cashReceivedInput');
    const changeDueSpan = document.getElementById('changeDueSpan');

    let cart = [];
    window.cart = cart;
    let activeCategory = 'all';

    function renderProducts(category="all"){
      productsGrid.innerHTML = "";
      const cats = category==="all" ? Object.keys(MENU) : [category];
      cats.forEach(cat=>{
        Object.entries(MENU[cat]).forEach(([name,item])=>{
          const div = document.createElement("div");
          div.className="product";
          div.innerHTML=`
            <img src="${item.image}" alt="${name}" onerror="this.style.display='none'">
            <div class="info">
              <div class="name">${name}</div>
              <div class="note">${cat}</div>
              <div class="price">₱${item.price.toFixed(2)}</div>
              <button>Add</button>
            </div>`;
          div.querySelector("button").addEventListener("click",()=>addToCart({id:item.item_id,name,price:item.price,category:cat}));
          productsGrid.appendChild(div);
        });
      });
    }

    function addToCart(product){
      const existing = cart.find(i=>i.id===product.id);
      if(existing){ existing.qty++; }
      else{ cart.push({...product, qty:1}); }
      renderCart();
    }

    function renderCart(){
      cartItemsEl.innerHTML = "";
      let subtotal=0;

      cart.forEach(item=>{
        subtotal += item.price * item.qty;

        const row = document.createElement("div");
        row.className = "cart-item";
        row.innerHTML = `
          <div class="meta"><strong>${item.name}</strong><span class="note">${item.category}</span></div>
          <div class="qty">
            <input type="number" min="1" value="${item.qty}">
            <span><strong>₱${(item.price*item.qty).toFixed(2)}</strong></span>
            <button class="remove">Remove</button>
          </div>`;

        row.querySelector("input").addEventListener("input", e => {
          const v = parseInt(e.target.value,10);
          item.qty = Number.isFinite(v) && v>0 ? v : 1;
          renderCart();
        });

        row.querySelector(".remove").addEventListener("click", () => {
          cart = cart.filter(c=>c.id!==item.id);
          renderCart();
        });

        cartItemsEl.appendChild(row);
      });

      
      const totals = computeTotals(getSelectedDiscount());
      cartTotalEl.textContent = totals.total.toFixed(2);
    }

    document.querySelectorAll(".category-bar button").forEach(btn=>{
      btn.addEventListener("click",()=>{
        document.querySelectorAll(".category-bar button").forEach(b=>b.classList.remove("active"));
        btn.classList.add("active");
        activeCategory = btn.dataset.category;
        renderProducts(activeCategory);
      });
    });

    clearCartBtn.addEventListener("click", ()=> { cart=[]; renderCart(); });

    function computeTotals(discountType='none'){
      const subtotal = cart.reduce((s,i)=> s + i.price*i.qty, 0);
      const discountRate = DISCOUNT_MAP[discountType] || 0;
      const discountAmt = subtotal * discountRate;
      const taxable = Math.max(0, subtotal - discountAmt);
      const vat = taxable * VAT_RATE;
      const total = taxable + vat;
      return { subtotal, discountRate, discountAmt, vat, total };
    }

    doneBtn.addEventListener("click", () => {
      if (cart.length === 0) { alert("Your cart is empty."); return; }

      paymentForm.reset();
      cashDetails.style.display = "none";
      cashReceivedInput.value = "";
      changeDueSpan.textContent = "0.00";

      modalCartItems.innerHTML = "";
      cart.forEach(item => {
        const line = document.createElement("div");
        line.className = "cart-line";
        line.innerHTML = `<span>${item.name} x${item.qty}</span><span>₱${(item.price*item.qty).toFixed(2)}</span>`;
        modalCartItems.appendChild(line);
      });

      const t = computeTotals('none');
      modalTotalSpan.textContent = t.total.toFixed(2);

      paymentModal.style.display = "flex";
    });

    paymentForm.querySelectorAll('input[name="payment"]').forEach(r=>{
      r.addEventListener('change', ()=>{
        const method = getSelectedPayment();
        cashDetails.style.display = method === 'cash' ? 'block' : 'none';
        updateModalTotals();
      });
    });

    paymentForm.querySelectorAll('input[name="discount_card_type"]').forEach(r=>{
      r.addEventListener('change', updateModalTotals);
    });

    cashReceivedInput.addEventListener('input', ()=>{
      const t = computeTotals(getSelectedDiscount());
      const cash = parseFloat(cashReceivedInput.value || '0');
      const change = Math.max(0, cash - t.total);
      changeDueSpan.textContent = change.toFixed(2);
    });

    function updateModalTotals(){
      const t = computeTotals(getSelectedDiscount());
      modalTotalSpan.textContent = t.total.toFixed(2);

      if(getSelectedPayment()==='cash'){
        const cash = parseFloat(cashReceivedInput.value || '0');
        const change = Math.max(0, cash - t.total);
        changeDueSpan.textContent = change.toFixed(2);
      }else{
        changeDueSpan.textContent = "0.00";
      }
    }

    function getSelectedPayment(){
      const r = paymentForm.querySelector('input[name="payment"]:checked');
      return r ? r.value : null;
    }
    function getSelectedDiscount(){
      const r = paymentForm.querySelector('input[name="discount_card_type"]:checked');
      return r ? r.value : 'none';
    }

    cancelPaymentBtn.addEventListener("click", ()=> paymentModal.style.display = "none");
    paymentModal.addEventListener("click", (e) => { if (e.target === paymentModal) paymentModal.style.display = "none"; });

    renderProducts();
    renderCart();
  </script>

  <script type="module">
    import { addDoc, collection, serverTimestamp }
      from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";

    paymentForm.addEventListener('submit', async (e) => {
      e.preventDefault();

      if(window.cart.length===0){
        alert('Cart is empty.');
        return;
      }

      const method = getSelectedPayment();
      if(!method){
        alert('Choose a payment method.');
        return;
      }

      const discountType = getSelectedDiscount();
      const t = computeTotals(discountType);

      if(method==='cash'){
        const cash = parseFloat(cashReceivedInput.value || '0');
        if(cash < t.total){
          alert('Cash received is less than total.');
          return;
        }
      }

      
      const safeCart = window.cart.map(i => ({
        id: i.id,
        name: i.name,
        price: i.price,
        qty: i.qty,
        category: i.category
      }));

      try {
        const orderRef = await addDoc(collection(window.Firebase.db, "orders"), {
          items: safeCart,
          totals: t,
          paymentMethod: method,
          discountType,
          cashierUid: window.Firebase.auth.currentUser?.uid || 'anonymous',
          createdAt: serverTimestamp()
        });

        await addDoc(collection(window.Firebase.db, "logs"), {
          whoUid: window.Firebase.auth.currentUser?.uid || 'anonymous',
          action: "ORDER_CREATED",
          details: { orderId: orderRef.id, total: t.total },
          createdAt: serverTimestamp()
        });

        alert(`Payment successful. Order saved with ID: ${orderRef.id}`);

        cart.length = 0;
        renderCart();
        paymentModal.style.display = "none";

      } catch(err) {
        console.error("Error saving order:", err);
        alert("Failed to save order. Check console for details.");
      }
    });
  </script>
</body>
</html>
